{"version":3,"sources":["athens/listeners.cljs"],"mappings":"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","names":["athens.listeners/mouse-down-bullet","e","class-list","cljs.core.array_seq.cljs$core$IFn$_invoke$arity$1","p1__54553#","cljs.core/some","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","start-pos","uid","on-move","athens.listeners/mouse-move-bullet","goog.events/listen","js/window","goog.events.EventType/MOUSEMOVE","G__54554","G__54555","G__54556","goog.events.EventType/MOUSEUP","athens.listeners/mouse-up-bullet","evt","cX","cY","x","y","closest-sibling","js/document.elementFromPoint","closest-child","closest","or__4185__auto__","closest-uid","closest-kind","p1__54557#","cljs.core.prn.cljs$core$IFn$_invoke$arity$variadic","G__54558","re-frame.core/dispatch","_evt","map__54559","cljs.core/deref","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","kind","target-uid","G__54560","re-frame.core/subscribe","G__54562","G__54563","js/document.getSelection","goog.events/unlisten","athens.listeners/mouse-down-block","closest-block","closest-block-header","closest-page-header","G__54564","athens.listeners/mouse-over-bullet","tooltip-uid","G__54566","p1__54565#","G__54567","G__54568","athens.listeners/mouse-down-outside-athena","athena?","G__54569","and__4174__auto__","G__54570","athens.listeners/init","goog.events.EventType/MOUSEDOWN","goog.events.EventType/MOUSEOVER"],"sourcesContent":["(ns athens.listeners\n  (:require\n    [cljsjs.react]\n    [cljsjs.react.dom]\n    [goog.events :as events]\n    [re-frame.core :refer [dispatch subscribe]])\n  (:import\n    (goog.events\n      EventType)))\n\n\n;;; Drag Bullet to Re-order Block\n\n\n(declare mouse-move-bullet mouse-up-bullet)\n\n\n(defn mouse-down-bullet\n  [e]\n  (let [class-list (-> (.. e -target -classList) array-seq)]\n    (when (some #(= \"bullet\" %) class-list)\n      (let [start-pos {:x (.-clientX e)\n                       :y (.-clientY e)}\n            uid (.. e -target -dataset -uid)\n            on-move (mouse-move-bullet start-pos uid)]\n        (events/listen js/window EventType.MOUSEMOVE on-move)\n        (events/listen js/window EventType.MOUSEUP (mouse-up-bullet on-move))))))\n\n\n(defn mouse-move-bullet\n  [start-pos uid]\n  (fn [evt]\n    (let [cX (.-clientX evt)\n          cY (.-clientY evt)\n          x (- cX (:x start-pos))\n          y (- cY (:y start-pos))\n          closest-sibling (.. (js/document.elementFromPoint cX cY) (closest \".block-container\"))\n          closest-child (.. (js/document.elementFromPoint cX cY) (closest \".block-contents\"))\n          closest (or closest-child closest-sibling)\n          closest-uid (when closest (.. closest -dataset -uid))\n          closest-kind (when closest (if (some #(= \"block-container\" %) (array-seq (.. closest -classList)))\n                                       :sibling\n                                       :child))]\n      (prn x y uid closest-uid closest-kind)\n      (dispatch [:drag-bullet {:x         x :y y\n                               :uid          uid\n                               :closest/uid  closest-uid\n                               :closest/kind closest-kind}]))))\n\n\n(defn mouse-up-bullet\n  [on-move]\n  (fn [_evt]\n    (let [{:keys [uid closest/kind] target-uid :closest/uid} @(subscribe [:drag-bullet])]\n      (when target-uid\n        (dispatch [:drop-bullet {:source uid :target target-uid :kind kind}]))\n      (dispatch [:drag-bullet {}])\n      (.. (js/document.getSelection) empty)\n      (events/unlisten js/window EventType.MOUSEMOVE on-move))))\n\n\n;;; Turn read block or header into editable on mouse down\n\n\n(defn mouse-down-block\n  [e]\n  ;; Consider refactor if we add more editable targets\n  (let [closest-block (.. e -target (closest \".block-contents\"))\n        closest-block-header (.. e -target (closest \".block-header\"))\n        closest-page-header (.. e -target (closest \".page-header\"))\n        closest (or closest-block closest-block-header closest-page-header)]\n    (when closest\n      (dispatch [:editing-uid (.. closest -dataset -uid)]))))\n\n\n;;; Show tooltip\n\n\n(defn mouse-over-bullet\n  [e]\n  (let [class-list (array-seq (.. e -target -classList))\n        closest (.. e -target (closest \".tooltip\"))\n        uid (.. e -target -dataset -uid)\n        tooltip-uid @(subscribe [:tooltip-uid])]\n    (cond\n      ;; if mouse over bullet, show tooltip\n      (some #(= \"bullet\" %) class-list) (dispatch [:tooltip-uid uid])\n      ;; if mouse over a child of bullet, keep tooltip-uid\n      closest nil\n      ;; if tooltip is already nil, don't overwrite tooltip-uid\n      (nil? tooltip-uid) nil\n      ;; otherwise mouse is no longer over a bullet or tooltip. clear the tooltip-uid\n      :else (dispatch [:tooltip-uid nil]))))\n\n\n;;; Close Athena\n\n\n(defn mouse-down-outside-athena\n  [e]\n  (let [athena? @(subscribe [:athena])\n        closest (.. e -target (closest \".athena\"))]\n    (when (and athena? (nil? closest))\n      (dispatch [:toggle-athena]))))\n\n\n(defn init\n  []\n  (events/listen js/window EventType.MOUSEDOWN mouse-down-block)\n  (events/listen js/window EventType.MOUSEDOWN mouse-down-bullet)\n  (events/listen js/window EventType.MOUSEOVER mouse-over-bullet)\n  (events/listen js/window EventType.MOUSEDOWN mouse-down-outside-athena))\n"]}